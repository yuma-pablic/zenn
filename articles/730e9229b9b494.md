---
title: "『AWSコンテナ設計・構築[本格]入門』をTerraformで再現した"
emoji: "📚"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["terraform","AWS","Iac"]
published: false
---

## 背景
2022年のインターン時、クラウド技術に対する知識不足を痛感しました。
そこで、より深く学ぶために『AWSコンテナ設計・構築[本格]入門』を手に取りました。
しかし、この書籍の内容をすべて手動で管理するのは時間的にも厳しく、またリソースの削除忘れを恐れインフラをIac化することを決意しました。

## Iac化への取り組み

モジュール構成（module composition）の概念を活用し、アーキテクチャを構築しました。

## アプリケーションの技術選定について
基本的には普段業務で使っているモノです
* Backend: Goを使用し、SQLcを採用。
* タスクランナー: Taskfileを使用。

## カスタマイズポイント
本書の内容をベースにしつつ、何点かは別のクラウドサービスに移行しました。

* CodeCommit → GitHub: リポジトリはGitHubを使用。
* CodeBuild → GitHub Actions: CI/CDにはGitHub Actionsを採用。
* CloudShell → ecspresso: ECSの管理にはecspressoを活用。

フロントエンド纏わるモジュールにバックエンドとほぼ同じなので今回省略しています。

## モジュール構成とアーキテクチャ設計
Terraformを用いた際の基本構成は以下の通りです。
環境ごとにディレクトリで分ける構成を取りました。
Module Composition

## アレンジをした点

- ポリシー周りのコードが複雑になりがちだったため、管理しやすいように別ファイルに切り出しました。ポリシーのドキュメントはdataリソースとして管理をしました。
- リソース名も統一し、コードの見通しを良くするためにLintツールを導入することも検討しました。


## 苦労した点と課題
モジュールの依存関係の管理には特に苦労しました。
例えば、シークレット管理では、データベースモジュールがないと難しい部分があり、DBへの依存が発生しました。
DIパターンを採用することも考えましたが、結局TerraformやCloudFormationだけでは完結しない場面も多く、ECSの管理にはecspresso、KubernetesではManifestの知識が必要だと感じました。
depends_onでの依存関係解決が難しかった点も課題です。


## 総括と感想
Terraformを用いたIac化に1年、そしてこの書籍を手にしてから1年半の時間が経ちました。
最初はクラウド知識に対する不安から始まったこの取り組みですが、多くの学びと成長を得ることができました。
今後も、学びを続け、さらに良いインフラ設計を目指していきたいと思います。

バックエンドのコードはかなり酷いのであまり参考にはなりません。
